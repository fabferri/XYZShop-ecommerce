{% extends "base.html" %}
{% load static %}

{% block title %}
    {{ product.name }}
{% endblock %}

{% block content %}
    <div class="container">
        <div class="product-detail">
            <div class="detail-image-container">
                <div class="category-label">{{ product.category.name }}</div>
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                    <img src="https://via.placeholder.com/500x400?text=No+Image" alt="{{ product.name }}">
                {% endif %}
            </div>
            <div class="product-info">
                <h1>{{ product.name }}</h1>
                <p class="price">£{{ product.price }}</p>
                
                {% if product.stock > 0 %}
                    <p style="color: green; font-weight: bold;">In Stock ({{ product.stock }} available)</p>
                {% else %}
                    <p style="color: red; font-weight: bold;">Out of Stock</p>
                {% endif %}
                
                <div class="description">
                    <h3>Description</h3>
                    {{ product.description|linebreaks }}
                </div>
                
                {% if product.stock > 0 %}
                    <form action="{% url 'cart:cart_add' product.id %}" method="post">
                        {% csrf_token %}
                        <p>
                            <label for="id_quantity">Quantity:</label>
                            {{ cart_product_form.quantity }}
                        </p>
                        {{ cart_product_form.update }}
                        <input type="submit" value="Add to Cart" class="btn">
                    </form>
                {% endif %}
                
                <a href="{% url 'products:product_list' %}" style="display: inline-block; margin-top: 2rem; color: #006400;">← Back to Products</a>
            </div>
        </div>
        
        <!-- Customer Reviews Section -->
        <div class="product-reviews" style="margin-top: 3rem; padding: 2rem; background-color: #f9f9f9; border-radius: 8px;">
            <h2>Customer Reviews</h2>
            
            {% if rating_count > 0 %}
                <!-- Rating Summary -->
                <div class="rating-summary" style="display: flex; align-items: center; gap: 2rem; margin: 1.5rem 0; padding: 1.5rem; background: white; border-radius: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; font-weight: bold; color: #333;">{{ average_rating }}</div>
                        <div style="font-size: 1.5rem; color: #ffa500;">
                            {% for i in "12345" %}
                                {% if forloop.counter <= average_rating %}★{% else %}☆{% endif %}
                            {% endfor %}
                        </div>
                        <div style="color: #666; margin-top: 0.5rem;">{{ rating_count }} review{{ rating_count|pluralize }}</div>
                    </div>
                    
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                            <span style="width: 60px;">5 ★</span>
                            <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; margin: 0 1rem; overflow: hidden;">
                                {% if rating_count > 0 %}
                                    <div style="width: {% widthratio rating_distribution.5 rating_count 100 %}%; height: 100%; background: #ffa500;"></div>
                                {% endif %}
                            </div>
                            <span style="width: 40px; text-align: right; color: #666;">{{ rating_distribution.5 }}</span>
                        </div>
                        <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                            <span style="width: 60px;">4 ★</span>
                            <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; margin: 0 1rem; overflow: hidden;">
                                {% if rating_count > 0 %}
                                    <div style="width: {% widthratio rating_distribution.4 rating_count 100 %}%; height: 100%; background: #ffa500;"></div>
                                {% endif %}
                            </div>
                            <span style="width: 40px; text-align: right; color: #666;">{{ rating_distribution.4 }}</span>
                        </div>
                        <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                            <span style="width: 60px;">3 ★</span>
                            <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; margin: 0 1rem; overflow: hidden;">
                                {% if rating_count > 0 %}
                                    <div style="width: {% widthratio rating_distribution.3 rating_count 100 %}%; height: 100%; background: #ffa500;"></div>
                                {% endif %}
                            </div>
                            <span style="width: 40px; text-align: right; color: #666;">{{ rating_distribution.3 }}</span>
                        </div>
                        <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                            <span style="width: 60px;">2 ★</span>
                            <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; margin: 0 1rem; overflow: hidden;">
                                {% if rating_count > 0 %}
                                    <div style="width: {% widthratio rating_distribution.2 rating_count 100 %}%; height: 100%; background: #ffa500;"></div>
                                {% endif %}
                            </div>
                            <span style="width: 40px; text-align: right; color: #666;">{{ rating_distribution.2 }}</span>
                        </div>
                        <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                            <span style="width: 60px;">1 ★</span>
                            <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; margin: 0 1rem; overflow: hidden;">
                                {% if rating_count > 0 %}
                                    <div style="width: {% widthratio rating_distribution.1 rating_count 100 %}%; height: 100%; background: #ffa500;"></div>
                                {% endif %}
                            </div>
                            <span style="width: 40px; text-align: right; color: #666;">{{ rating_distribution.1 }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Individual Reviews -->
                <div class="reviews-list" style="margin-top: 2rem;">
                    {% for review in reviews %}
                        <div class="review-item" style="background: white; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid #ffa500;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <div style="color: #ffa500; font-size: 1.2rem; margin-bottom: 0.3rem;">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                                        {% endfor %}
                                    </div>
                                    {% if review.title %}
                                        <h3 style="margin: 0.5rem 0; font-size: 1.1rem;">{{ review.title }}</h3>
                                    {% endif %}
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #333;">{{ review.user.get_full_name|default:review.user.username }}</div>
                                    {% if review.verified_purchase %}
                                        <div style="color: #28a745; font-size: 0.85rem;">✓ Verified Purchase</div>
                                    {% endif %}
                                    <div style="color: #666; font-size: 0.85rem; margin-top: 0.3rem;">{{ review.created|date:"F d, Y" }}</div>
                                </div>
                            </div>
                            <p style="color: #555; line-height: 1.6; margin: 0;">{{ review.comment }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p style="color: #666; text-align: center; padding: 2rem;">No reviews yet. Be the first to review this product!</p>
            {% endif %}
        </div>
    </div>
{% endblock %}
